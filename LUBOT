import discord
import asyncio

client = discord.Client(intents=discord.Intents.all())

@client.event
async def on_ready():
    guild = client.guilds[0]
    category_name = "Server Stats"
    category = discord.utils.get(guild.categories, name=category_name)
    if category is None:
        category = await guild.create_category(category_name)

    online_members_channel_name = "ğŸŸ¢ Online Members"
    online_members_channel = discord.utils.get(guild.voice_channels, name=online_members_channel_name)
    if online_members_channel is None:
        online_members_channel = await guild.create_voice_channel(online_members_channel_name, category=category)

    online_bots_channel_name = "ğŸ¤– Online Bots"
    online_bots_channel = discord.utils.get(guild.voice_channels, name=online_bots_channel_name)
    if online_bots_channel is None:
        online_bots_channel = await guild.create_voice_channel(online_bots_channel_name, category=category)

    total_members_channel_name = "ğŸ‘¥ Total Members"
    total_members_channel = discord.utils.get(guild.voice_channels, name=total_members_channel_name)
    if total_members_channel is None:
        total_members_channel = await guild.create_voice_channel(total_members_channel_name, category=category)

    # ë§´ë²„, ë´‡, ì „ì²´ ë§´ë²„ ì±„ë„ì˜ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ìŒì„±ê¶Œí•œì„ ì—†ì•°
    for channel in [online_members_channel, online_bots_channel, total_members_channel]:
        for member in guild.members:
            await channel.set_permissions(member, connect=False)

    for member in guild.members:
        await member.edit(voice_channel=None)

    async def update_member_count():
        await client.wait_until_ready()
        guild = client.guilds[0]

        online_members_channel = discord.utils.get(guild.voice_channels, name="ğŸŸ¢ Online Members")
        online_bots_channel = discord.utils.get(guild.voice_channels, name="ğŸ¤– Online Bots")
        total_members_channel = discord.utils.get(guild.voice_channels, name="ğŸ‘¥ Total Members")

        while True:
            online_members = len([m for m in guild.members if m.status != discord.Status.offline and not m.bot])
            online_bots = len([m for m in guild.members if m.status != discord.Status.offline and m.bot])
            total_members = guild.member_count

            if not online_members_channel.name.endswith(f"{online_members + online_bots}"):
                await online_members_channel.edit(name=f"ğŸŸ¢ Online Members: {online_members + online_bots}")
            if not online_bots_channel.name.endswith(f"{online_bots}"):
                await online_bots_channel.edit(name=f"ğŸ¤– Online Bots: {online_bots}")
            if not total_members_channel.name.endswith(f"{total_members}"):
                await total_members_channel.edit(name=f"ğŸ‘¥ Total Members: {total_members}")

            await asyncio.sleep(10)

    client.loop.create_task(update_member_count())

@client.event
async def on_ready():
    print("Logged in as {0.user}".format(client))

@client.event
async def on_ready():
    print("Logged in as {0.user}".format(client))

@client.event
async def on_message(message):
    # ë©”ì‹œì§€ë¥¼ ë°›ì„ ì±„ë„ ID
    receive_channel_id = 1102690275064807444

    # ë³´ë‚´ëŠ” ë©”ì‹œì§€ì˜ ì¡°ê±´: ê°™ì€ ì„œë²„ì—ì„œ ì§€ì •ëœ ì±„ë„ì—ì„œ ì‘ì„±ë¨
    if message.guild and message.channel.id == 1102744888845533277:
        # ë°›ëŠ” ì±„ë„ ì°¾ê¸°
        receive_channel = client.get_channel(receive_channel_id)

        # Embed ë©”ì‹œì§€ ë§Œë“¤ê¸°
        embed = discord.Embed(title="Rules", description=message.content, color=0x00ff00)
        embed.set_author(name=message.author.display_name, icon_url=message.author.avatar.url)

        # Embed ë©”ì‹œì§€ë¥¼ ë°›ëŠ” ì±„ë„ë¡œ ì „ì†¡
        await receive_channel.send(embed=embed)
    
    # ë´‡ì´ ë°›ì•„ë“¤ì¼ ëª…ë ¹ì–´
    if message.content.startswith('!send'):
        # ì±„íŒ…ì„ ë³´ë‚¼ ì±„ë„ ì„ íƒ
        await message.channel.send("ì–´ëŠ ì±„ë„ì— ì±„íŒ…ì„ ë³´ë‚¼ê¹Œìš”? (#ì±„ë„ëª…)")
        
        def check(m):
            return m.author == message.author and m.channel == message.channel
        
        # ì‚¬ìš©ìë¡œë¶€í„° ì±„íŒ… ì±„ë„ ì´ë¦„ ì…ë ¥ ë°›ìŒ
        msg = await client.wait_for('message', check=check)
        channel_name = msg.content.strip('#')
        channel = discord.utils.get(message.guild.channels, name=channel_name)
        
        if not channel:
            await message.channel.send(f"{channel_name} ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        # ì±„íŒ…ì„ ë³´ë‚¼ ë‚´ìš© ì…ë ¥ ë°›ìŒ
        await message.channel.send("ë¬´ì—‡ì„ ë³´ë‚¼ê¹Œìš”?")
        
        # ì‚¬ìš©ìë¡œë¶€í„° ë©”ì‹œì§€ ë‚´ìš© ì…ë ¥ ë°›ìŒ
        msg = await client.wait_for('message', check=check)
        
        # Embed ë©”ì‹œì§€ ë§Œë“¤ê¸°
        embed = discord.Embed(title=" {0.author.display_name}".format(message), description=msg.content, color=0x00ff00)
        
        # Embed ë©”ì‹œì§€ë¥¼ ë°›ëŠ” ì±„ë„ë¡œ ì „ì†¡
        await channel.send(embed=embed)

client.run("MTEwMjY4Mjg3ODgwODE3NDY5NA.GZh4E3.Q1SHMMCaQCkCtfwtpLN9AmPxfQRsjlEFVKhrQ0")
